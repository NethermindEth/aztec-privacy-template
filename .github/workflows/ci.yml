name: CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: "1.3.6"
  NODE_VERSION: "20"
  AZTEC_VERSION: "3.0.0-devnet.6-patch.1"

jobs:
  generator-baseline-matrix:
    name: Generator baseline (${{ matrix.pm }} / ${{ matrix.example }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        pm: [bun, npm, pnpm, yarn]
        example: [none, aave, lido, uniswap, all]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install generator dependencies
        run: make generator-install

      - name: Build generator package
        run: make generator-build

      - name: Verify generator baseline contract
        env:
          CAPT_MATRIX_PM: ${{ matrix.pm }}
          CAPT_MATRIX_EXAMPLE: ${{ matrix.example }}
        run: |
          cd packages/create-aztec-privacy-template
          node --test test/baseline-contract.test.mjs

  generator-e2e-matrix:
    name: Generator E2E (${{ matrix.pm }} / ${{ matrix.example }} / ${{ matrix.install_mode }})
    runs-on: ubuntu-latest
    timeout-minutes: 35
    strategy:
      fail-fast: false
      matrix:
        pm: [bun, npm, pnpm, yarn]
        example: [none, aave, lido, uniswap, all]
        install_mode: [skip, install]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Enable corepack package managers
        shell: bash
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate
          corepack prepare yarn@stable --activate
          npm --version
          pnpm --version
          yarn --version
          bun --version

      - name: Install generator dependencies
        run: make generator-install

      - name: Run generator E2E matrix case
        env:
          CAPT_E2E_PM: ${{ matrix.pm }}
          CAPT_E2E_EXAMPLE: ${{ matrix.example }}
          CAPT_E2E_INSTALL_MODE: ${{ matrix.install_mode }}
        run: make generator-e2e-case

  generator-published-artifact-smoke:
    name: Generator published artifact smoke
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install generator dependencies
        run: make generator-install

      - name: Run published artifact smoke
        run: make generator-published-artifact-smoke

  quality-and-contract-build:
    name: Quality + Solidity + Aztec compile
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Foundry (forge/cast/anvil)
        uses: foundry-rs/foundry-toolchain@v1

      - name: Setup Aztec CLI
        shell: bash
        run: |
          INSTALL_URL="https://install.aztec.network/${AZTEC_VERSION}/"
          curl -sL "$INSTALL_URL" > /tmp/aztec-install.sh
          VERSION="$AZTEC_VERSION" bash /tmp/aztec-install.sh <<< yes "yes"
          echo "$HOME/.aztec/current/bin" >> "$GITHUB_PATH"
          echo "$HOME/.aztec/current/node_modules/.bin" >> "$GITHUB_PATH"
          echo "$HOME/.aztec/bin" >> "$GITHUB_PATH"

      - name: Tool versions
        run: |
          bun --version
          node --version
          forge --version
          cast --version
          anvil --version
          aztec --version

      - name: Install repository dependencies
        run: make install

      - name: Format check
        run: make fmt-check

      - name: Lint check
        run: make lint

      - name: Solidity compile check
        shell: bash
        run: |
          set -euo pipefail
          for dir in \
            packages/core/solidity \
            packages/protocols/aave/solidity \
            packages/protocols/uniswap/solidity \
            packages/protocols/lido/solidity \
            tests/mocks/aave/solidity \
            tests/mocks/uniswap/solidity \
            tests/mocks/lido/solidity
          do
            echo "Compiling Solidity contracts in $dir"
            forge build --root . --contracts "$dir"
          done

      - name: Aztec contract compile check
        run: make build-aztec

  e2e:
    name: E2E (Aztec local network + L1)
    needs: quality-and-contract-build
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Foundry (forge/cast/anvil)
        uses: foundry-rs/foundry-toolchain@v1

      - name: Setup Aztec CLI
        shell: bash
        run: |
          INSTALL_URL="https://install.aztec.network/${AZTEC_VERSION}/"
          curl -sL "$INSTALL_URL" > /tmp/aztec-install.sh
          VERSION="$AZTEC_VERSION" bash /tmp/aztec-install.sh <<< yes "yes"
          echo "$HOME/.aztec/current/bin" >> "$GITHUB_PATH"
          echo "$HOME/.aztec/current/node_modules/.bin" >> "$GITHUB_PATH"
          echo "$HOME/.aztec/bin" >> "$GITHUB_PATH"

      - name: Install repository dependencies
        run: make install

      - name: Run E2E suite
        run: make test-e2e
