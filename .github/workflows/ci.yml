name: CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: "1.3.6"
  AZTEC_VERSION: "3.0.0-devnet.6-patch.1"

jobs:
  quality-and-contract-build:
    name: Quality + Solidity + Aztec compile
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Foundry (forge/cast/anvil)
        uses: foundry-rs/foundry-toolchain@v1

      - name: Setup Aztec CLI
        shell: bash
        run: |
          bash -i <(curl -sL https://install.aztec.network)
          export PATH="$HOME/.aztec/bin:$PATH"
          aztec-up "$AZTEC_VERSION"
          echo "$HOME/.aztec/bin" >> "$GITHUB_PATH"

      - name: Tool versions
        run: |
          bun --version
          node --version
          forge --version
          cast --version
          anvil --version
          aztec --version

      - name: Install repository dependencies
        run: make install

      - name: Format check
        run: make fmt-check

      - name: Lint check
        run: make lint

      - name: Solidity compile check
        shell: bash
        run: |
          set -euo pipefail
          for dir in \
            packages/core/solidity \
            packages/protocols/aave/solidity \
            packages/protocols/uniswap/solidity \
            packages/protocols/lido/solidity \
            tests/mocks/aave/solidity \
            tests/mocks/uniswap/solidity \
            tests/mocks/lido/solidity
          do
            echo "Compiling Solidity contracts in $dir"
            forge build --root . --contracts "$dir"
          done

      - name: Aztec contract compile check
        run: make build-aztec

  e2e:
    name: E2E (Aztec local network + L1)
    needs: quality-and-contract-build
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Foundry (forge/cast/anvil)
        uses: foundry-rs/foundry-toolchain@v1

      - name: Setup Aztec CLI
        shell: bash
        run: |
          bash -i <(curl -sL https://install.aztec.network)
          export PATH="$HOME/.aztec/bin:$PATH"
          aztec-up "$AZTEC_VERSION"
          echo "$HOME/.aztec/bin" >> "$GITHUB_PATH"

      - name: Install repository dependencies
        run: make install

      - name: Run E2E suite
        run: make test-e2e
